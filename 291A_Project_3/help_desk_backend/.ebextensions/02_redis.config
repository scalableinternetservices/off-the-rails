packages:
  dnf:
    redis: []

commands:
  01_configure_redis:
    command: |
      if [ -f /etc/redis/redis.conf ]; then
        sudo sed -i 's/^bind .*/bind 127.0.0.1/' /etc/redis/redis.conf
        sudo sed -i 's/^protected-mode yes/protected-mode no/' /etc/redis/redis.conf
      elif [ -f /etc/redis.conf ]; then
        sudo sed -i 's/^bind .*/bind 127.0.0.1/' /etc/redis.conf
        sudo sed -i 's/^protected-mode yes/protected-mode no/' /etc/redis.conf
      fi
    ignoreErrors: true
    
  02_reload_systemd:
    command: "sudo systemctl daemon-reload"
    ignoreErrors: true
    
  03_enable_redis:
    command: "sudo systemctl enable redis"
    ignoreErrors: true
    
  04_start_redis:
    command: |
      sudo systemctl start redis
      for i in {1..10}; do
        if redis-cli ping > /dev/null 2>&1; then
          echo "Redis is ready"
          exit 0
        fi
        echo "Waiting for Redis... attempt $i"
        sleep 2
      done
      echo "Redis may not be ready yet, but continuing..."
      exit 0
    ignoreErrors: false