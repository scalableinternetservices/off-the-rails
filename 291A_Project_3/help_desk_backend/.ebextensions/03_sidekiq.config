files:
  "/etc/systemd/system/sidekiq.service":
    mode: "000644"
    owner: root
    group: root
    content: |
      [Unit]
      Description=Sidekiq Background Worker
      After=syslog.target network.target redis.service

      [Service]
      Type=simple
      User=webapp
      Group=webapp
      WorkingDirectory=/var/app/current
      # Load environment variables from the file EB creates
      EnvironmentFile=/opt/elasticbeanstalk/deployment/env
      ExecStart=/bin/bash -lc 'bundle exec sidekiq -C config/sidekiq.yml'
      
      # Restart automatically if it crashes
      Restart=always
      RestartSec=1

      # Output logs to standard syslog
      StandardOutput=syslog
      StandardError=syslog
      SyslogIdentifier=sidekiq

      [Install]
      WantedBy=multi-user.target

commands:
  01_reload_systemd:
    command: "systemctl daemon-reload"
  02_restart_sidekiq:
    command: "systemctl restart sidekiq || systemctl start sidekiq"